services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: youtube-ai-automation
    ports:
      # Cloudflare Tunnel chạy trên host sẽ trỏ về origin http://localhost:6789
      - "6789:6789"
    environment:
      # Database
      # NOTE: default points to sqlite db inside persisted volume
      - DATABASE_URL=${DATABASE_URL:-file:/app/prisma/prisma/dev.db}
      
      # Auth.js / NextAuth v5
      - NEXTAUTH_URL=${NEXTAUTH_URL}
      - AUTH_SECRET=${AUTH_SECRET}
      - AUTH_GOOGLE_ID=${AUTH_GOOGLE_ID}
      - AUTH_GOOGLE_SECRET=${AUTH_GOOGLE_SECRET}
      
      # Node environment
      - NODE_ENV=production
    # On Ubuntu, bind-mounting SQLite often hits permission issues.
    # Use a named volume for DB persistence.
    volumes:
      - sqlite_data:/app/prisma/prisma
    restart: unless-stopped
    command: sh -c "npx prisma@6.0.1 migrate deploy && node server.js"

  # Cloudflare Tunnel (khuyến nghị dùng Public Hostname trên Cloudflare dashboard)
  # 1) Create tunnel + add Public Hostname:
  #    script.giadinhnhimsoc.site  ->  http://app:6789
  # 2) Paste token into CLOUDFLARE_TUNNEL_TOKEN in your .env
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: youtube-ai-cloudflared
    profiles: ["tunnel"]
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    depends_on:
      - app
    restart: unless-stopped

volumes:
  sqlite_data:

# Nếu muốn sử dụng PostgreSQL thay vì SQLite:
# 
# services:
#   db:
#     image: postgres:16-alpine
#     container_name: youtube-ai-db
#     environment:
#       POSTGRES_USER: ${POSTGRES_USER:-postgres}
#       POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
#       POSTGRES_DB: ${POSTGRES_DB:-youtube_ai}
#     volumes:
#       - postgres_data:/var/lib/postgresql/data
#     ports:
#       - "5432:5432"
#     restart: unless-stopped
#
#   app:
#     build:
#       context: .
#       dockerfile: Dockerfile
#     container_name: youtube-ai-automation
#     depends_on:
#       - db
#     ports:
#       - "6789:6789"
#     environment:
#       - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-youtube_ai}
#       - NEXTAUTH_URL=http://localhost:6789
#       - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
#       - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
#       - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
#       - GEMINI_API_KEY=${GEMINI_API_KEY}
#       - NODE_ENV=production
#     restart: unless-stopped
#     command: sh -c "npx prisma migrate deploy && node server.js"
#
# volumes:
#   postgres_data:
